import pandas as pd
import numpy as np

ED_colkeep = ('SL NO','UEN','NRIC/FIN','Type of Pass',
              'Name','Mobile No','Type of Residence',
              'Area of Profesional','Occupation',
              'Is the individual appointed as a Safe Management Officer (SMO)?',
              'Is the individual appointed as a Safe Distancing Officer (SDO)?',
              'Is the individual appointed as a COVID Safe Worker Leader?',
              'Is the individual based in a worksite/facility?','Company',
              'Direct Employer Company Name','STREET NAME',
              'BLOCK','LEVEL','UNIT','Work Zone e.g Blk 1 lvl 8, zone A etc',
              'Team identifier')
FD_colkeep = ('SL NO','UEN','Direct Employer Company Name',
              'Name of company POC',
              'Mobile of company POC',
              'Email of company POC')


def read(path,sheet):
    df = pd.read_excel(path,sheet)
    return df
def extract(df):
    df_em = df
    data_c = ('SL NO',
              'Role in organisation',
              'Direct Employer Company Name',
              'Team identifier',
              'NRIC/FIN',
              'Name',
              'Activity',
              'Work level',
              'Work Zone e.g Blk 1 lvl 8, zone A etc',
              'Arrival time (HH:MM AM/PM)',
              'Morning break (HH:MM AM/PM, duration)',
              'Lunch time (HH:MM AM/PM, duration)',
              'Afternoon break (HH:MM AM/PM, duration)',
              'Exit time (HH:MM AM/PM)')
    df_STP = pd.DataFrame()
    for i in data_c:
        df_STP[i] = df_em[i]
    df_STP.rename(columns={'Role in organisation':'Role',
                           'Direct Employer Company Name':'Firm',
                           'Name':'Name of worker/staff',
                           'Activitiy':'Activity to be carried out',
                           'Work level':'Location of work - Floor',
                           'Work Zone e.g Blk 1 lvl 8, zone A etc':'Location of work - Zone'},inplace=True)
    return df_STP

def remove_blanks_duplicates(df):
    #remove duplicates in Employee details sheet
    df.drop_duplicates(subset = ['NRIC/FIN'],keep = "first", inplace = True)#source is changed
    #remove blanks or #N/A values
    df.dropna(axis = 0,how ='any', subset = ['NRIC/FIN'],inplace = True)
    df.index = np.arange(1,len(df)+1)
    df['SL NO'] = df.index
    df['Area of Profesional'].fillna('NA',inplace=True)
    return df

def align_format(df):
    global ED_colkeep
    lst = ('STREET NAME','BLOCK','LEVEL','UNIT','Work Zone e.g Blk 1 lvl 8, zone A etc',
           'Team identifier')
    df_col = list(df.columns)
    for col in df_col:
        if col not in ED_colkeep:
            df.drop(columns=[col],inplace=True)
    
    for i in lst:
        df[i].fillna('NA',inplace=True)
    #reorder columns
    df_1 = df.reindex(columns=['SL NO','UEN','NRIC/FIN','Name','Mobile No','Type of Residence','Area of Profesional','Occupation',
                               'Is the individual appointed as a Safe Management Officer (SMO)?',
                               'Is the individual appointed as a Safe Distancing Officer (SDO)?',
                               'Is the individual appointed as a COVID Safe Worker Leader?',
                               'Is the individual based in a worksite/facility?','Company',
                               'Direct Employer Company Name','STREET NAME','BLOCK','LEVEL','UNIT','Work Zone e.g Blk 1 lvl 8, zone A etc','Team identifier','Type of Pass'])
    return df_1

def write_BCA(path,df1,df2,df3,df4):
    with pd.ExcelWriter(path) as writer:
        df1.to_excel(writer, sheet_name = 'Firm Details', index=False)
        df2.to_excel(writer, sheet_name = 'Employee Details', index=False)
        df3.to_excel(writer, sheet_name = '(LS) Segregated Team Plan', index=False)
        df4.to_excel(writer, sheet_name = 'Worksite Details', index=False)

def add_company(df):
    global FD_colkeep
    proj_ref = []
    df_col = list(df.columns)

    for i in df_col:
        if i not in FD_colkeep:
            df.drop(columns=[i],inplace=True)
            
    df.drop_duplicates(subset = ['UEN'],keep = "first", inplace = True) #drop duplicates
    df.index = np.arange(1,len(df)+1)
    df['SL NO'] = df.index
    for i in range(len(df.index)):
        proj_ref.append('A0552-01579-2018')
    df.insert(1,'BCA Project Reference No / Contract No / Unique Identifier No',proj_ref,False)               
    df.rename(columns={'SL NO':'Serial No',
                       'Direct Employer Company Name':'Firm Name',
                       'Name of company POC':'Representative Name',
                       'Mobile of company POC':'Representative Mobile No',
                       'Email of company POC':'Representative Email'},inplace=True)
    return df

        
def BCA_main():
    path1 = str(input("Please enter in file location of test file:\n"))
    path1 = path1.replace('\\','/')

    #initialise dataframes
    df_EMv1 = remove_blanks_duplicates(read(path1,1))
    df_FD = df_EMv1.copy(deep=True)
    df_FD1 = add_company(df_FD)
    df_STP = extract(df_EMv1)
    df_EMv1 = align_format(df_EMv1)
    df_WD = read(path1,3)

    write_BCA(path1,df_FD1,df_EMv1,df_STP,df_WD)
    print('BCA format ready')
