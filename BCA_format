import pandas as pd
import numpy as np
from collections import Counter
import random

ED_colkeep = ('SL NO','UEN','NRIC/FIN','Type of Pass',
              'Name','Mobile No','Type of Residence',
              'Area of Profesional','Occupation',
              'Is the individual appointed as a Safe Management Officer (SMO)?',
              'Is the individual appointed as a Safe Distancing Officer (SDO)?',
              'Is the individual appointed as a COVID Safe Worker Leader?',
              'Is the individual based in a worksite/facility?','Company',
              'Direct Employer Company Name','STREET NAME',
              'BLOCK','LEVEL','UNIT','Work Zone e.g Blk 1 lvl 8, zone A etc',
              'Team identifier')
FD_colkeep = ('SL NO','Role in Firm','UEN','Direct Employer Company Name',
              'Name of company POC',
              'Mobile of company POC',
              'Email of company POC',
              'Role of Firms')

def read(path,sheet):
    df = pd.read_excel(path,sheet)
    return df
def extract(df):
    df_em = df
    data_c = ('SL NO',
              'Role in organisation',
              'Direct Employer Company Name',
              'Team identifier',
              'NRIC/FIN',
              'Name',
              'Activity',
              'Work level',
              'Work Zone e.g Blk 1 lvl 8, zone A etc',
              'Arrival time (HH:MM AM/PM)',
              'Morning break (HH:MM AM/PM, duration)',
              'Lunch time (HH:MM AM/PM, duration)',
              'Afternoon break (HH:MM AM/PM, duration)',
              'Exit time (HH:MM AM/PM)')
    df_STP = pd.DataFrame()
    for i in data_c:
        df_STP[i] = df_em[i]
    df_STP.rename(columns={'Role in organisation':'Role',
                           'Direct Employer Company Name':'Firm',
                           'Name':'Name of worker/staff',
                           'Activitiy':'Activity to be carried out',
                           'Work level':'Location of work - Floor',
                           'Work Zone e.g Blk 1 lvl 8, zone A etc':'Location of work - Zone'},inplace=True)
    return df_STP

def remove_blanks_duplicates(df):
    #remove duplicates in Employee details sheet
    df.drop_duplicates(subset = ['NRIC/FIN'],keep = "first", inplace = True)#source is changed
    #remove blanks or #N/A values
    df.dropna(axis = 0,how ='any', subset = ['NRIC/FIN'],inplace = True)
    df.index = np.arange(1,len(df)+1)
    df['SL NO'] = df.index
    df['Area of Profesional'].fillna('NA',inplace=True)
    return df

def align_format(df):
    global ED_colkeep
    lst = ('STREET NAME','BLOCK','LEVEL','UNIT','Work Zone e.g Blk 1 lvl 8, zone A etc',
           'Team identifier')
    df_col = list(df.columns)
    for col in df_col:
        if col not in ED_colkeep:
            df.drop(columns=[col],inplace=True)
    
    for i in lst:
        df[i].fillna('NA',inplace=True)
    #reorder columns
    df_1 = df.reindex(columns=['SL NO','UEN','NRIC/FIN','Name','Mobile No','Type of Residence','Area of Profesional','Occupation',
                               'Is the individual appointed as a Safe Management Officer (SMO)?',
                               'Is the individual appointed as a Safe Distancing Officer (SDO)?',
                               'Is the individual appointed as a COVID Safe Worker Leader?',
                               'Is the individual based in a worksite/facility?','Company',
                               'Direct Employer Company Name','STREET NAME','BLOCK','LEVEL','UNIT','Work Zone e.g Blk 1 lvl 8, zone A etc','Team identifier','Type of Pass'])
    return df_1

def write_BCA(path,df1,df2,df3,df4):
    with pd.ExcelWriter(path) as writer:
        df1.to_excel(writer, sheet_name = 'Firm Details', index=False)
        df2.to_excel(writer, sheet_name = 'Employee Details', index=False)
        df4.to_excel(writer, sheet_name = 'Worksite Details', index=True)
        df3.to_excel(writer, sheet_name = '(LS) Segregated Team Plan', index=False)

def add_company(df):
    global FD_colkeep
    proj_ref = []
    df_col = list(df.columns)

    for i in df_col:
        if i not in FD_colkeep:
            df.drop(columns=[i],inplace=True)
            
    df.drop_duplicates(subset = ['UEN'],keep = "first", inplace = True) #drop duplicates
    df.index = np.arange(1,len(df)+1)
    df['SL NO'] = df.index
    for i in range(len(df.index)):
        proj_ref.append('A0552-01579-2018')
    df.insert(1,'BCA Project Reference No / Contract No / Unique Identifier No',proj_ref,False)               
    df.rename(columns={'SL NO':'Serial No',
                       'Direct Employer Company Name':'Firm Name',
                       'Name of company POC':'Representative Name',
                       'Mobile of company POC':'Representative Mobile No',
                       'Email of company POC':'Representative Email'},inplace=True)
    df_1= df.reindex(columns=['Serial No','BCA Project Reference No / Contract No / Unique Identifier No',
                              'Role of Firms','UEN','Firm Name','Representative Name',
                              'Representative Mobile No','Representative Email'])

    return df_1

def worksite(df):
    #pass in copy of EMv1(deep copy)
    #create new dataframe ['Zone','Activity', 'Team', 'week 0' - 'week12']
    df_worksite = pd.DataFrame(columns = ['Work Zone e.g Blk 1 lvl 8, zone A etc','Activity','Team identifier',
                                          'Week 0','Week 1','Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6',
                                          'Week 7', 'Week 8', 'Week 9', 'Week 10', 'Week 11', 'Week 12'])
    df_worksite.fillna(0)#fill all cells with 0
    #remove blanks
    df.dropna(axis = 0,how ='any', subset = ['Team identifier'],inplace = True)
    df_wd_columns = list(df_worksite.columns)
    for i in df_wd_columns[0:3]:
        #assign df values fo df_worksite values
        #column names must be the same
        df_worksite[i] = df[i]
    #store team list in a dictonary(key = team, value = count)
    dic = dic_team(df_worksite['Team identifier'])
    #remove all duplicates from team
    df_worksite.drop_duplicates(subset = ['Team identifier'],keep = "first", inplace = True)
    #dic should be a dic{key = team, value = count of team}
    #call calculate func to fill in weeks
    df_worksite.index = df_worksite['Team identifier']
    df_worksite = calc_team(dic, df_worksite)
    df_worksite.index = np.arange(1,len(df_worksite)+1)
    return df_worksite

def calc_team(dic,df):
    weekly_list = ('1-1','2-1','2-2','2-3','40-1')#full attendence every week
    client_subcon_temp = ('41-1','41-2','41-3','41-4','41-5','41-6','41-7',
                          '43-1','44-1','45-1','46-1','47-1','48-1')
    wt = ((df.columns))[3:]
    df_weeks= list(df.columns)#list of columns names to be iterated
    df_weeks = df_weeks[3:]#drop out first columns name
    team_list = df['Team identifier']#index
    for team in df['Team identifier']:
        val = dic.get(team_list[team])
        if team_list[team] in weekly_list:
            for week in wt:
                df.loc[team,week] = val
        elif team_list[team] in client_subcon_temp:
            for week in wt[:5:1]:
                df.loc[team,week] = val
        else:#team in neither 
            if (val%3) == 1:
                #if activity is WSH
                if df.loc[team, 'Activity'] == 'WSH' or df.loc[team, 'Activity'] == 'Scaffolding work':#WSH and scafoldding exception
                    for week in wt:
                        df.loc[team,week] = val
                else:
                    if val>10:
                        for week in wt[::2]:#all even weeks
                            df.loc[team,week] = (val//2) + int(random.randrange(0,(val//3),1))
                        for week in wt[1::2]:#all odd weeks
                            df.loc[team,week] = (val//2) + int(random.randrange(0,(val//5),1))
                    else:
                        for week in wt:
                            df.loc[team,week] = val
            else:#val<100 or val == 100
                if df.loc[team, 'Activity'] == 'WSH' or df.loc[team, 'Activity'] == 'Scaffolding work':##WSH and scafoldding exception
                    for week in wt:
                        df.loc[team,week] = val
                else:
                    if val>10:
                        for week in wt[::2]:# all even weeks
                            df.loc[team,week] = (val//2) + int(random.randrange(0,(val//3),1))
                        for week in wt[1::2]:#all odd weeks
                            df.loc[team,week] = (val//2) + int(random.randrange(0,(val//5),1))
                            
                    else:#val<10
                        for week in wt:
                            df.loc[team,week] = val
    #fill all missing cells as int(0)\
    for week in wt:
        df[week].fillna(int(0),inplace=True)
    return df

def dic_team(df):#pass of one column in argument
    d = Counter(list(df))
    return d
    

if __name__ == '__main__':
    path1 = str(input("Please enter in file location of test file:\n"))
    path1 = path1.replace('\\','/')
    #initialise dataframes
    df_EMv1 = remove_blanks_duplicates(read(path1,1))
    df_FD = df_EMv1.copy(deep=True)#deep copy1
    df_wdv1 = df_EMv1.copy(deep=True)#deep copy2
    #worksite calc
    df_WD = worksite(df_wdv1)

    #company details alignment
    df_FD1 = add_company(df_FD)

    #STP
    df_STP = extract(df_EMv1)

    #Employee details align
    df_EMv1 = align_format(df_EMv1)

    #write all into new file
    write_BCA(path1,df_FD1,df_EMv1,df_STP,df_WD)
    print('BCA format ready')
